<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Draevorn IA - Intelligence Artificielle</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&display=swap" rel="stylesheet">
<style>
body{margin:0;font-family:'Orbitron',sans-serif;background:#000;color:#fff}
#chat-container{max-width:900px;margin:80px auto;padding:20px}
.chat-box{background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.06);border-radius:18px;padding:18px;min-height:300px;max-height:60vh;overflow:auto}
.message{margin:8px 0;padding:10px 14px;border-radius:12px;max-width:75%;word-wrap:break-word}
.user{align-self:flex-end;background:rgba(106,90,255,0.65)}
.ai{align-self:flex-start;background:rgba(138,107,255,0.65)}
.typing{font-style:italic;opacity:0.85}
#input-area{display:flex;gap:12px;margin-top:12px}
#msg{flex:1;padding:10px;border-radius:10px;border:1px solid #333;background:#000;color:#fff;resize:none}
button{padding:10px 14px;border-radius:10px;border:none;background:#6a5aff;color:#fff;cursor:pointer}
.note{margin-top:12px;color:#cfcfcf;font-size:13px}
#test-controls{margin-top:10px;display:flex;gap:8px}
</style>
</head>
<body>

<div id="chat-container">
  <h1 style="text-align:center;color:#bb00ff">Draevorn IA</h1>

  <div class="chat-box" id="chat-box" aria-live="polite"></div>

  <div id="input-area">
    <textarea id="msg" rows="3" placeholder="Posez une question à Draevorn..."></textarea>
    <div style="display:flex;flex-direction:column;gap:8px">
      <button id="send-btn">Envoyer</button>
      <div id="test-controls">
        <button id="run-test">Run test (local)</button>
        <button id="clear">Clear</button>
      </div>
    </div>
  </div>



<script>
/**
 * FIX for ReferenceError: process is not defined
 * - Browsers do not have `process.env`.
 * - For quick testing only: set API_KEY to your key here (not secure).
 * - If API_KEY === 'TA_CLE_ICI' the script will simulate responses locally so you can test UI without making requests.
 */

const API_KEY = "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"; // <-- Remplace par ta clé si tu comprends le risque (ex : "sk-...")

async function sendMessage(){
  const input = document.getElementById('msg');
  const chatBox = document.getElementById('chat-box');
  const msg = input.value.trim();
  if(!msg) return;

  appendMessage(msg, 'user');
  input.value = '';
  chatBox.scrollTop = chatBox.scrollHeight;

  const aiEl = appendMessage('Draevorn réfléchit...', 'ai', true);

  try{
    // If API_KEY is default placeholder, simulate response to avoid runtime errors and accidental API calls
    if(API_KEY === 'TA_CLE_ICI'){
      await delay(700 + Math.random()*700);
      aiEl.textContent = '[SIMULATION] Voici une réponse exemple à : "' + msg + '"';
      aiEl.classList.remove('typing');
      chatBox.scrollTop = chatBox.scrollHeight;
      return;
    }

    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + API_KEY
      },
      body: JSON.stringify({
        model: 'gpt-3.5-turbo',
        messages: [{ role: 'user', content: msg }]
      })
    });

    if(!res.ok){
      const text = await res.text();
      throw new Error('API error: ' + res.status + ' - ' + text);
    }

    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content || '❌ Réponse vide.';
    aiEl.textContent = reply;
    aiEl.classList.remove('typing');
  }catch(err){
    console.error(err);
    aiEl.textContent = '❌ Erreur : ' + (err.message || err);
    aiEl.classList.remove('typing');
  }

  chatBox.scrollTop = chatBox.scrollHeight;
}

function appendMessage(text, cls, typing=false){
  const chatBox = document.getElementById('chat-box');
  const el = document.createElement('div');
  el.className = 'message ' + cls + (typing? ' typing':'');
  el.textContent = text;
  // For user messages align right
  el.style.alignSelf = (cls === 'user') ? 'flex-end' : 'flex-start';
  chatBox.appendChild(el);
  return el;
}

function delay(ms){ return new Promise(r => setTimeout(r, ms)); }

// Test harness: adds a couple of test prompts. Useful as "test cases" when no API key provided.
async function runLocalTest(){
  clearChat();
  const tests = [
    'Bonjour, qui es-tu ?',
    'Donne-moi trois idées de quêtes pour Draevorn.'
  ];
  for(const t of tests){
    document.getElementById('msg').value = t;
    await sendMessage();
    await delay(300);
  }
}

function clearChat(){ document.getElementById('chat-box').innerHTML=''; }

// Bind UI
document.getElementById('send-btn').addEventListener('click', sendMessage);
document.getElementById('run-test').addEventListener('click', runLocalTest);
document.getElementById('clear').addEventListener('click', clearChat);

// Accessibility: send on Ctrl+Enter
document.getElementById('msg').addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.key==='Enter') sendMessage(); });

// If the user wants the secure approach, ask here in chat and I will generate a Cloudflare Worker + deployment steps.
</script>

</body>
</html>
